@page "/game"
@using Ludo.Blazor.Components.Components.Game
@using Ludo.Game.Controller
@using Ludo.Game.Enums
@using Ludo.Game.Interfaces
@using Ludo.Game.Models.Board
@using Ludo.Game.Models.Dice
@using Ludo.Game.Models.Piece
@using Ludo.Game.Models.Player
@using Ludo.Game.Utils.BoardGenerate
@inject NavigationManager Nav
@inject GameSessionService Session
@inject SoundService Sound

<div class="game-page">
    <main class="game-main">
        <PlayerIndicator Player="currentPlayer" />
        <section class="board-section">
            <BoardView Board="currentGame.Board" PiecesPostion="currentGame.PiecePositions"
                       ClickablePieces="clickablePieces" OnPieceClicked="OnPieceClicked" OnPieceHover="OnPieceHover"
                       OnPieceHoverOut="ClearPreview" PreviewTile="previewTile" />

            <Toasts class="p-3" Messages="messages" AutoHide="true" Delay="3000" StackLength="3"
                    Placement="ToastsPlacement.BottomCenter" />
        </section>
        <DiceIndicator DiceValue="lastDiceValue" CanRoll="canRollDice" IsRolling="isRolling" OnRoll="RollDice" />
    </main>
    <button @onclick="MoveAllPieceToGoal">ended</button>
</div>

@code {
    GameController currentGame = null!;
    IPlayer currentPlayer => currentGame.GetCurrentPlayer();
    Random random = new Random();
    Tile? previewTile;
    HashSet<Piece> clickablePieces = new();

    int lastDiceValue = 1;
    public bool canRollDice { get; private set; } = true;
    public bool isRolling { get; private set; }

    List<ToastMessage> messages = new List<ToastMessage>();

    private void ShowMessage(ToastType toastType, string title, string message)
    {
        messages.Add(
        new ToastMessage
        {
            Type = toastType,
            Title = title,
            Message = message,

        }
    );
    }

    protected override void OnInitialized()
    {
        if (Session.Game == null)
        {
            Nav.NavigateTo("/", replace: true);
            return;
        }

        currentGame = Session.Game!;
        Sound.PlayStart();

        ShowMessage(ToastType.Primary, "Player Turn", $"Turn for {currentPlayer.Name}");

        currentGame.OnCaptured += async (attacker, victim) =>
        {
            await Sound.PlayKill();
            ShowMessage(ToastType.Danger, "Piece Killed!", $"{attacker.Name} captured a {victim.Color} piece");
        };
    }

    async Task RollDice()
    {
        isRolling = true;
        canRollDice = false;
        StateHasChanged();

        await Sound.PlayDice();

        for (int i = 0; i < 10; i++)
        {
            lastDiceValue = random.Next(1, currentGame.Dice.Sides + 1);
            StateHasChanged();
            await Task.Delay(80);
        }

        lastDiceValue = currentGame.RollDice();
        clickablePieces = currentGame.GetMoveablePieces(currentPlayer).ToHashSet();

        if (clickablePieces.Count == 0)
        {
            EndTurn();
        }
        else
        {
            await Sound.PlayCanMove();
            ShowMessage(ToastType.Info, "Move Piece", $"{currentPlayer.Name} has {clickablePieces.Count} moveable pieces");
        }

        isRolling = false;
        StateHasChanged();
    }

    async void OnPieceClicked(Piece piece)
    {
        if (!clickablePieces.Contains(piece))
            return;

        await Sound.PlayMove();

        clickablePieces.Clear();

        currentGame.MovePiece(currentPlayer, piece);

        if (currentGame.IsTurnFinished())
        {
            EndTurn();
        }
        else
        {
            canRollDice = true;
        }

        ClearPreview();
        StateHasChanged();
    }

    async Task AfterMove(Piece piece)
    {
        if (currentGame.GetPieceTile(piece)?.Zone == Zone.Goal)
        {
            await Sound.PlayGoal();
            ShowMessage(ToastType.Success, "Goal Reached", $"{currentPlayer.Name} piece reached goal!");
        }

        if (currentGame.IsTurnFinished())
        {
            EndTurn();
        }
        else
        {
            ShowMessage(ToastType.Info, "Bonus Turn", $"{currentPlayer.Name} gets another turn!");
            canRollDice = true;
        }
    }

    void OnPieceHover(Piece piece)
    {
        if (!clickablePieces.Contains(piece)) return;

        Tile? currentTile = currentGame.GetPieceTile(piece);
        List<Tile> path = currentGame.Board.ColorPaths[piece.Color];

        if (currentTile == null || currentTile.Zone == Zone.Home)
        {
            previewTile = lastDiceValue == currentGame.Dice.Sides ? path[0] : null;
            return;
        }

        int index = path.IndexOf(currentTile);
        int target = index + lastDiceValue;

        previewTile = target < path.Count ? path[target] : null;
    }

    void ClearPreview()
    {
        previewTile = null;
    }

    void EndTurn()
    {
        if (currentGame.IsGameOver())
        {
            Session.GetWinner();
            Nav.NavigateTo("/winner");
        }
        else
        {
            ClearPreview();
            clickablePieces.Clear();
            canRollDice = true;
            currentGame.NextTurn();

            Sound.PlayTurn();
            ShowMessage(ToastType.Primary, "Player Turn", $"Turn for {currentPlayer.Name}");
        }
    }

    void MoveAllPieceToGoal()
    {
        currentGame.MoveAllPieceToGoal(currentPlayer);
        EndTurn();
    }
}